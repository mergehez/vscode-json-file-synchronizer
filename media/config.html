<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Arg JSON File Synchronizer</title>
</head>
<body style="height: 100vh;">
    <h1 style="padding-bottom: 10px; text-align: center; width: 100%;">Arg JSON File Synchronizer <curr_time/></h1>
	<form style="display: flex; padding: 20px; flex-direction: column; font-size: 1.2rem;" onsubmit="event.preventDefault(); submitForm();">
		<div style="padding: 10px 0;">
            To use the extension you must select the files containing json. Type a directory to get available files<br/>
            <i>- If the files are in the root path located, just type <b>/</b></i><br/>
            <i>- Separate extensions by comma</i>
        </div>
		<div style="display: flex; align-items: center; margin-top:10px;">
			<label for="input-folder" style="width: 150px;">Directory: </label>
			<input type="text" id="input-folder" placeholder="e.g. src/localization" style="padding: 5px; font-size: 1.2rem; flex-grow: 1;" required="required" value="[FOLDER]">
		</div>
		<div style="display: flex; align-items: center; margin-top:10px;">
			<label for="input-folder" style="width: 150px;">File extensions: </label>
			<input type="text" id="input-exts" placeholder="e.g. separate by commas" style="padding: 5px; font-size: 1.2rem; flex-grow: 1;" required="required" value="[FILEEXTS]">
		</div>
		<div style="display: flex; align-items: center; margin-top:10px;">
			<label for="input-recursive" style="width: 150px;">Recursive: </label>
			<input type="checkbox" id="input-recursive" style="height: 20px; width: 20px;">
		</div>
		<div id="error" style="color:red; padding: 10px 0; display: none;"></div>
		<div>
			<input type="submit" style="margin-top: 10px; padding: 5px 20px; font-size: 1.2rem; width: initial;" value="Search for files"></input>
		</div>
	</form>

	<div style="display: none; padding: 10px 20px; max-height: 50%; flex-direction: column; font-size: 1.2rem;" id="second-form">
		<div style="margin-top: 20px;">
			<span>JSON files in the directory. <i>(Please uncheck files which does not contain translations)</i></span>
			<div style="margin-top: 10px; padding: 5px; border: 1px #bbb solid;" id="file-list-div">
	
			</div>
		</div>
		<div>
			<input type="button" id="btn-save" style="margin-top: 15px; padding: 5px 20px; font-size: 1.2rem; width: initial;" value="Save"></input>
		</div>
	</form>
</body>

<script>
	let vscode;
    let latestExts = "", latestFolder = "";
	function submitForm(e){
		const inputFolder = document.getElementById("input-folder");
		const inputExts = document.getElementById("input-exts");
		const folder = inputFolder.value;
		if(folder.trim().length == 0 || inputExts.value.trim().length == 0){
			inputFolder.value = "";
			inputExts.value = "";
			return;
		}
        latestFolder = folder;
        latestExts = inputExts.value.trim().split(",").map(t => t.trim());
		vscode.postMessage({ 
			command: 'getFilesInFolder', 
			folderPath : folder,
            fileExts: latestExts, 
			recursive: document.getElementById("input-recursive").checked
		});
	}
	(function () {
		vscode = acquireVsCodeApi();
		const secondForm = document.getElementById("second-form");
		const fileListDiv = document.getElementById("file-list-div");
		const errorDiv = document.getElementById("error");

		window.addEventListener('message', event => {
			const message = event.data; 
			if(message.command == "file-list"){
				const list = message.list;

				const noDir = list == "directory not found";
				if(noDir || list.length == 0){
					errorDiv.innerHTML = noDir ? "The given directory does not exists. Please check it." : "No JSON file found int the given directory.";
					errorDiv.style.display = "block";
					fileListDiv.innerHTML = "";
					secondForm.style.display = "none"
					return;
				}

				errorDiv.style.display = "none";
				
				let content = '';
				for (let i = 0; i < list.length; i++) {
					content += 
						'<div style="display: flex; align-items: center; padding: 5px 0px;">'
							+'<input type="checkbox" class="file-list-item" id="filename-'+i+'" checked style="width: 20px; height: 20px;">'
							+'<label style="padding-left: 10px;" class="noselect" for="filename-'+i+'">'+list[i]+'</label>'
						+'</div>';
				}
				fileListDiv.innerHTML = content;
				secondForm.style.display = "flex"
				return;
			}
		});

		document.getElementById("btn-save").addEventListener("click", () => {
			var fileNames = Array.from(document.querySelectorAll(".file-list-item:checked + label")).map(el => el.innerHTML);

            if(latestExts.length > 0){
                vscode.postMessage({ 
                    command: 'setConfig', 
                    key : "fileExtensions",
                    value: latestExts,
                    refresh: 0
                });
            }

            if(latestFolder.length > 0){
                vscode.postMessage({ 
                    command: 'setConfig', 
                    key : "folder",
                    value: latestFolder,
                    refresh: 0
                });
            }

            vscode.postMessage({ 
				command: 'setConfig', 
				key : "files",
				value: fileNames,
				refresh: 1
			});
		});
	}());

</script>
</html>